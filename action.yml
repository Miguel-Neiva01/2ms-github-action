name: Run 2MS Scan

description: |
  GitHub Action that clones the repositories, builds the 2MS binary, installs dependencies, and runs the scan.

inputs:
  commit_hash:
    description: 'Commit hash to run the scan on'
    required: true

runs:
  using: "composite"
  steps:
   - name: Checkout 2MS repository
     uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
     with:
      repository: checkmarx/2ms
      ref: dcbb5a70a5844d19550d916868398a4bab114138 
       echo "Using commit hash: dcbb5a70a5844d19550d916868398a4bab114138"  # Exibindo o commit sendo utilizado

     # ref: ${{ inputs.commit_hash }}

   - uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
     with:
       go-version: "^1.22"

   - name: go mod tidy
     run: |
       go mod tidy
       git diff --exit-code

   - name: Install system dependencies
     run: |
       sudo apt-get update
       sudo apt-get install -y python3 python3-pip git npm
       npm install

   - name: Build 2MS binary
     run: |
       cd 2ms
       go build -o /tmp/2ms main.go
       
   - name: Run 2MS Scan
     run: |
       /tmp/2ms

   - name: Run entrypoint
     run: |
       python3 ./entrypoint.py
